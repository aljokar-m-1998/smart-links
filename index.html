<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مُنشئ صفحة الروابط الذكية - النسخة الاحترافية</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&family=Cairo:wght@400;700;900&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- الإعدادات العامة والمتغيرات --- */
        :root {
            --editor-bg: #f7f8fa;
            --preview-bg: #eef0f5;
            --widget-bg: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #555;
            --border-color: #e0e0e0;
            --accent-color: #007bff;
            --accent-hover: #0056b3;
            --danger-color: #dc3545;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --border-radius: 12px;
        }

        body {
            font-family: 'Cairo', sans-serif;
            margin: 0;
            background-color: var(--editor-bg);
            color: var(--text-primary);
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s;
        }

        /* --- أيقونات SVG --- */
        .icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            stroke-width: 0;
            stroke: currentColor;
            fill: currentColor;
            vertical-align: middle;
            margin-left: 8px;
        }
        
        /* --- تقسيم الشاشة: التحكم والمعاينة --- */
        #app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        #editor-panel {
            width: 450px;
            height: 100%;
            overflow-y: auto;
            background-color: var(--widget-bg);
            padding: 25px;
            border-left: 1px solid var(--border-color);
            box-shadow: -5px 0 15px rgba(0,0,0,0.05);
        }

        #preview-panel {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--preview-bg);
            padding: 20px;
            height: 100%;
            overflow: hidden;
        }

        /* --- تصميم لوحة التحكم --- */
        #editor-panel h1 {
            font-size: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        #editor-panel h1 .icon {
            color: var(--accent-color);
            margin-left: 10px;
        }

        .editor-section {
            background: var(--editor-bg);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        
        .editor-section summary {
            font-weight: 700;
            padding: 15px;
            cursor: pointer;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .editor-section summary::-webkit-details-marker { display: none; }
        .editor-section summary:after {
            content: '+';
            font-size: 1.5em;
            color: var(--accent-color);
        }
        .editor-section[open] summary:after { content: '−'; }

        .form-content {
            padding: 0 15px 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .form-group { margin-bottom: 15px; }
        
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }
        
        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: #fff;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-picker-group input[type="color"] {
            -webkit-appearance: none;
            width: 40px;
            height: 40px;
            border: none;
            padding: 0;
            border-radius: 50%;
            cursor: pointer;
        }
        .color-picker-group input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .color-picker-group input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        .btn-primary:hover { background-color: var(--accent-hover); }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover { background-color: #5a6268; }

        .btn-danger {
            background: transparent;
            color: var(--danger-color);
        }
        .btn-danger:hover { background-color: rgba(220, 53, 69, 0.1); }

        .btn-full { width: 100%; }

        #links-list .link-item, #social-links-list .social-link-item {
            background-color: #fff;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .drag-handle {
            cursor: move;
            color: #aaa;
        }
        
        .link-inputs { flex-grow: 1; }
        
        .dragging {
            opacity: 0.5;
            background: #e0f0ff;
        }
        
        /* --- تصميم لوحة المعاينة والهاتف --- */
        #preview-frame {
            width: 375px;
            height: 812px;
            background-color: white;
            border-radius: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 18px;
            box-sizing: border-box;
            overflow: hidden;
            position: relative;
        }
        
        #preview-frame::before { /* Notch */
            content: '';
            position: absolute;
            top: 18px;
            left: 50%;
            transform: translateX(-50%);
            width: 160px;
            height: 25px;
            background-color: #1a1a1a;
            border-radius: 0 0 15px 15px;
            z-index: 10;
        }

        #preview-content {
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
            border-radius: 22px;
            overflow-y: auto;
            text-align: center;
            padding: 40px 15px;
            box-sizing: border-box;
            word-break: break-word;
            transition: all 0.3s;
        }
        
        #preview-content::-webkit-scrollbar { display: none; }

        .preview-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 15px;
            border: 4px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .preview-name {
            font-size: 22px;
            font-weight: 900;
            margin: 0 0 8px;
        }
        .preview-bio {
            font-size: 15px;
            margin: 0 auto 20px;
            max-width: 90%;
            color: #333;
        }
        .preview-socials {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .preview-socials a {
            color: #333;
            font-size: 24px;
            transition: transform 0.2s;
        }
        .preview-socials a:hover {
            transform: scale(1.1);
        }
        .preview-links a {
            display: block;
            background-color: white;
            color: #1a1a1a;
            padding: 15px;
            margin: 0 auto 15px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s;
            max-width: 100%;
        }
        .preview-links a:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* --- نافذة الرابط المولد --- */
        #modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none; /* hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #modal-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        #modal-content h2 { margin-top: 0; }
        #generated-link {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            background: #f1f1f1;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: right;
            direction: ltr;
        }

        /* --- صفحة العرض النهائية --- */
        body.render-mode {
            display: block;
            height: auto;
        }
        body.render-mode #app-container,
        body.render-mode #editor-panel,
        body.render-mode #preview-panel {
            display: none;
        }
        #render-container {
            display: none;
        }
        body.render-mode #render-container {
            display: block;
        }

        /* --- التجاوب مع الشاشات الصغيرة --- */
        @media (max-width: 900px) {
            body {
                display: block;
                height: auto;
                overflow: auto;
            }
            #app-container {
                flex-direction: column;
            }
            #editor-panel {
                width: 100%;
                box-sizing: border-box;
                height: auto;
                border-left: none;
            }
            #preview-panel {
                height: 100vh;
                position: sticky;
                top: 0;
            }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <div id="editor-panel">
            <h1>
                <svg class="icon" viewBox="0 0 24 24"><path d="M19.4,3.9c-0.3-0.3-0.7-0.4-1.1-0.4H5.7C4.8,3.5,4,4.2,4,5.1v13.8c0,0.9,0.8,1.6,1.7,1.6h12.6c0.9,0,1.7-0.7,1.7-1.6V5.1C20,4.6,19.7,4.2,19.4,3.9z M18.3,18.9H5.7V5.1h12.6V18.9z"/><path d="M8.9,7.6c-0.5,0-0.8,0.4-0.8,0.8v0.8c0,0.5,0.4,0.8,0.8,0.8s0.8-0.4,0.8-0.8V8.4C9.7,7.9,9.4,7.6,8.9,7.6z"/><path d="M15.1,7.6h-3.8c-0.5,0-0.8,0.4-0.8,0.8s0.4,0.8,0.8,0.8h3.8c0.5,0,0.8-0.4,0.8-0.8S15.6,7.6,15.1,7.6z"/><path d="M15.1,11.3h-6.2c-0.5,0-0.8,0.4-0.8,0.8s0.4,0.8,0.8,0.8h6.2c0.5,0,0.8-0.4,0.8-0.8S15.6,11.3,15.1,11.3z"/><path d="M15.1,15.1h-6.2c-0.5,0-0.8,0.4-0.8,0.8s0.4,0.8,0.8,0.8h6.2c0.5,0,0.8-0.4,0.8-0.8S15.6,15.1,15.1,15.1z"/></svg>
                محرر الصفحة
            </h1>
            
            <details class="editor-section" open>
                <summary>المعلومات الأساسية</summary>
                <div class="form-content">
                    <div class="form-group">
                        <label for="profile-name">الاسم (مثال: @username)</label>
                        <input type="text" id="profile-name" placeholder="اسمك أو اسم المستخدم">
                    </div>
                    <div class="form-group">
                        <label for="profile-bio">الوصف (Bio)</label>
                        <textarea id="profile-bio" placeholder="وصف قصير عنك أو عن عملك..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="profile-avatar">الصورة الرمزية (رابط)</label>
                        <input type="url" id="profile-avatar" placeholder="https://example.com/image.png">
                    </div>
                </div>
            </details>
            
            <details class="editor-section">
                <summary>روابط التواصل الاجتماعي</summary>
                <div class="form-content" id="social-links-list">
                    </div>
            </details>

            <details class="editor-section" open>
                <summary>الروابط المخصصة</summary>
                <div class="form-content">
                    <div id="links-list">
                        </div>
                    <button id="add-link-btn" class="btn btn-primary btn-full">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M19,11h-6V5c0-0.55-0.45-1-1-1s-1,0.45-1,1v6H5c-0.55,0-1,0.45-1,1s0.45,1,1,1h6v6c0,0.55,0.45,1,1,1s1-0.45,1-1v-6h6c0.55,0,1-0.45,1-1S19.55,11,19,11z"/></svg>
                        إضافة رابط جديد
                    </button>
                </div>
            </details>

            <details class="editor-section" open>
                <summary>التصميم والمظهر</summary>
                <div class="form-content">
                     <div class="form-group">
                        <label for="theme-selector">الثيم (Theme)</label>
                        <select id="theme-selector">
                            <option value="light">فاتح</option>
                            <option value="dark">داكن</option>
                            <option value="gradient-pink">وردي متدرج</option>
                            <option value="gradient-blue">أزرق سماوي</option>
                            <option value="forest">غابة</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ألوان مخصصة</label>
                        <div class="color-picker-group">
                            <input type="color" id="bg-color" title="لون الخلفية">
                            <input type="color" id="link-bg-color" title="لون زر الرابط">
                            <input type="color" id="link-text-color" title="لون نص الرابط">
                            <input type="color" id="text-color" title="لون النص الأساسي">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="font-selector">الخط</label>
                        <select id="font-selector">
                            <option value="'Cairo', sans-serif">Cairo</option>
                            <option value="'Tajawal', sans-serif">Tajawal</option>
                            <option value="'Almarai', sans-serif">Almarai</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="button-style-selector">شكل الأزرار</label>
                        <select id="button-style-selector">
                            <option value="8px">دائري الأطراف</option>
                            <option value="25px">بيضاوي</option>
                            <option value="2px">حاد</option>
                        </select>
                    </div>
                </div>
            </details>

            <div class="actions" style="margin-top: 25px; display: flex; gap: 10px;">
                <button id="generate-link-btn" class="btn btn-primary" style="flex:1;">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M18,13h-2.1c-0.5,0-0.9,0.4-1,0.9l-0.8,4.3c-0.1,0.5,0.3,1,0.8,1.1c0.1,0,0.2,0,0.2,0c0.5,0,0.9-0.4,1-0.9l0.8-4.3h1.1c0.6,0,1-0.4,1-1S18.6,13,18,13z"/><path d="M9.1,14c-0.5-0.1-1,0.3-1.1,0.8L7.2,19.1c-0.1,0.5,0.3,1,0.8,1.1c0.1,0,0.2,0,0.2,0c0.5,0,0.9-0.4,1-0.9l0.8-4.3C10.1,14.4,9.7,14,9.1,14z"/><path d="M15,4L9.9,5.4C9.4,5.5,9,6,9,6.5v4.2c0,0.5,0.4,1,1,1h4c0.5,0,1-0.4,1-1V5C15,4.5,14.5,4,14,4z M13,9h-2V7h2V9z"/><path d="M12,1C5.9,1,1,5.9,1,12s4.9,11,11,11s11-4.9,11-11S18.1,1,12,1z M12,21c-5,0-9-4-9-9s4-9,9-9s9,4,9,9S17,21,12,21z"/></svg>
                    حفظ وتوليد رابط
                </button>
                <button id="download-html-btn" class="btn btn-secondary" style="flex:1;">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M19.4,3.9c-0.3-0.3-0.7-0.4-1.1-0.4H5.7C4.8,3.5,4,4.2,4,5.1v13.8c0,0.9,0.8,1.6,1.7,1.6h12.6c0.9,0,1.7-0.7,1.7-1.6V5.1C20,4.6,19.7,4.2,19.4,3.9z M18.3,18.9H5.7V5.1h12.6V18.9z"/><path d="M12,16.1c0.4,0,0.8-0.3,0.8-0.8v-5.8l1.7,1.7c0.3,0.3,0.8,0.3,1.1,0s0.3-0.8,0-1.1l-3.2-3.2c-0.3-0.3-0.8-0.3-1.1,0l-3.2,3.2c-0.3,0.3-0.3,0.8,0,1.1c0.3,0.3,0.8,0.3,1.1,0l1.7-1.7v5.8C11.2,15.8,11.6,16.1,12,16.1z"/></svg>
                    تحميل HTML
                </button>
            </div>
        </div>

        <div id="preview-panel">
            <div id="preview-frame">
                <div id="preview-content">
                    </div>
            </div>
        </div>
    </div>

    <div id="render-container"></div>
    
    <div id="modal">
        <div id="modal-content">
            <h2>تم توليد رابط صفحتك بنجاح!</h2>
            <p>شارك هذا الرابط مع جمهورك. عند فتحه، ستظهر صفحتك مباشرة.</p>
            <input type="text" id="generated-link" readonly>
            <div style="display: flex; gap: 10px;">
                <button id="copy-link-btn" class="btn btn-primary" style="flex:1;">نسخ الرابط</button>
                <button id="close-modal-btn" class="btn btn-secondary" style="flex:1;">إغلاق</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- فحص إذا كان يجب عرض الصفحة النهائية أم المحرر ---
        if (window.location.hash && window.location.hash.startsWith('#data=')) {
            try {
                const encodedData = window.location.hash.substring(6);
                const decodedData = JSON.parse(atob(encodedData));
                document.body.classList.add('render-mode');
                const finalHTML = generateFinalHTML(decodedData);
                document.getElementById('render-container').innerHTML = finalHTML;
                document.title = `${decodedData.profile.name} | صفحة الروابط`;
            } catch (error) {
                console.error("Failed to decode data from URL:", error);
                initializeApp(); // Fallback to editor if decoding fails
            }
        } else {
            initializeApp();
        }

    });

    function initializeApp() {
        // --- تعريف العناصر ---
        const elements = {
            profileName: document.getElementById('profile-name'),
            profileBio: document.getElementById('profile-bio'),
            profileAvatar: document.getElementById('profile-avatar'),
            linksList: document.getElementById('links-list'),
            socialLinksList: document.getElementById('social-links-list'),
            addLinkBtn: document.getElementById('add-link-btn'),
            previewContent: document.getElementById('preview-content'),
            
            // Design Elements
            themeSelector: document.getElementById('theme-selector'),
            bgColorPicker: document.getElementById('bg-color'),
            linkBgColorPicker: document.getElementById('link-bg-color'),
            linkTextColorPicker: document.getElementById('link-text-color'),
            textColorPicker: document.getElementById('text-color'),
            fontSelector: document.getElementById('font-selector'),
            buttonStyleSelector: document.getElementById('button-style-selector'),

            // Actions
            generateLinkBtn: document.getElementById('generate-link-btn'),
            downloadHtmlBtn: document.getElementById('download-html-btn'),
            modal: document.getElementById('modal'),
            generatedLinkInput: document.getElementById('generated-link'),
            copyLinkBtn: document.getElementById('copy-link-btn'),
            closeModalBtn: document.getElementById('close-modal-btn'),
        };

        // --- أيقونات SVG لشبكات التواصل الاجتماعي ---
        const socialIcons = {
            twitter: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></svg>',
            instagram: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.85s-.011 3.584-.069 4.85c-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07s-3.584-.012-4.85-.07c-3.252-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.85s.012-3.584.07-4.85c.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.85-.069zm0 1.802c-3.147 0-3.506.011-4.73.069-2.693.124-3.935 1.368-4.058 4.058-.057 1.224-.069 1.583-.069 4.73s.011 3.506.069 4.73c.123 2.69 1.365 3.935 4.058 4.058 1.224.057 1.583.069 4.73.069 3.147 0 3.506-.011 4.73-.069 2.693-.124 3.935-1.368 4.058-4.058.057-1.224.069-1.583.069-4.73s-.011-3.506-.069-4.73c-.123-2.69-1.365-3.935-4.058-4.058-1.224-.057-1.583-.069-4.73-.069zm0 4.64c-2.403 0-4.36 1.957-4.36 4.36s1.957 4.36 4.36 4.36 4.36-1.957 4.36-4.36-1.957-4.36-4.36-4.36zm0 7.161c-1.547 0-2.801-1.254-2.801-2.801s1.254-2.801 2.801-2.801 2.801 1.254 2.801 2.801-1.254 2.801-2.801 2.801zm4.42-8.625c-.777 0-1.408-.631-1.408-1.408s.631-1.408 1.408-1.408 1.408.631 1.408 1.408-.631 1.408-1.408 1.408z"></path></svg>',
            facebook: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V15H8v-3h2V9.5C10 7.57 11.57 6 13.5 6H16v3h-2c-.55 0-1 .45-1 1v2h3v3h-3v6.95c5.05-.5 9-4.76 9-9.95z"></path></svg>',
            tiktok: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.525.02c1.31-.02 2.61-.01 3.91.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-2.43.05-4.86-.95-6.69-2.81-1.77-1.77-2.9-4.14-2.9-6.66 0-2.52 1.13-4.89 2.9-6.66 1.83-1.92 4.32-2.94 6.78-2.94.02 1.38.01 2.75.01 4.13 0 1.4-.35 2.81-.97 4.1-.25.51-.56.98-.92 1.41-.35.42-.78.77-1.22 1.07-1.06.74-2.38 1.03-3.7.91-.55-.05-1.09-.16-1.6-.33-.48-.16-.92-.38-1.32-.65-.41-.27-.78-.59-1.11-.96-.33-.37-.6-.79-.82-1.23-.22-.44-.39-.9-.51-1.37-.11-.47-.16-.94-.18-1.42-.02-.48.01-.96.04-1.44.03-.48.09-.95.16-1.42.08-.47.18-.93.3-1.38.12-.45.28-.89.45-1.32.18-.43.39-.85.62-1.26.23-.4.49-.78.78-1.13.29-.35.61-.68.95-1.01.34-.32.7-.63 1.08-.91.38-.28.78-.54 1.19-.79.41-.24.84-.46 1.27-.65.43-.19.88-.35 1.33-.49.45-.14.9-.25 1.35-.33.45-.08.9-.13 1.36-.16.46-.03.92-.04 1.38-.04.46 0 .92.01 1.38.03.45.02.9.06 1.34.12.44.06.88.14 1.31.25.43.1.85.24 1.26.39.4.15.79.33 1.17.52.38.19.74.4 1.09.64.35.24.68.5 1.01.77.32.27.63.56.92.87.29.3.57.63.82.97.25.34.49.7.7 1.07.21.37.4.76.57 1.15.17.4.31.8.43 1.21.12.42.22.84.29 1.27.08.43.13.86.16 1.3.03.44.04.88.02 1.32-.02.44-.07.88-.14 1.32-.08.43-.18.86-.31 1.28-.12.42-.28.83-.46 1.23-.18.4-.39.79-.62 1.16-.24.37-.5.72-.79 1.06-.29.33-.6.65-.93.94-.33.3-.68.58-1.04.83-.36.25-.74.48-1.12.68-.39.2-.78.38-1.18.53-.4.15-.8.27-1.2.37-.4.1-.8.18-1.2.23-.4.05-.8.08-1.2.09-.4.01-.8.01-1.19-.01-.39-.02-.79-.05-1.18-.1-.39-.05-.78-.12-1.16-.21-.38-.09-.76-.2-1.13-.34-.37-.14-.73-.29-1.08-.48-.35-.18-.68-.39-.99-.62-.32-.23-.61-.48-.88-.75-.27-.27-.52-.56-.75-.87-.22-.31-.43-.63-.61-.96-.18-.33-.34-.67-.48-1.02-.14-.34-.26-.7-.35-1.06-.09-.36-.16-.72-.21-1.08-.05-.36-.09-.72-.11-1.08-.02-.36-.03-.72-.02-1.08.01-3.13.02-6.26.02-9.39z"></path></svg>',
            youtube: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M21.582,6.186c-0.23-0.86-0.908-1.538-1.768-1.768C18.254,4,12,4,12,4S5.746,4,4.186,4.418c-0.86,0.23-1.538,0.908-1.768,1.768C2,7.746,2,12,2,12s0,4.254,0.418,5.814c0.23,0.86,0.908,1.538,1.768,1.768C5.746,20,12,20,12,20s6.254,0,7.814-0.418c0.861-0.23,1.538-0.908,1.768-1.768C22,16.254,22,12,22,12S22,7.746,21.582,6.186z M10,15.464V8.536L16,12L10,15.464z"></path></svg>',
            linkedin: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.225 0z"></path></svg>',
            github: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>'
        };

        const socialPlatforms = ['twitter', 'instagram', 'facebook', 'tiktok', 'youtube', 'linkedin', 'github'];

        // --- الحالة الافتراضية للتطبيق ---
        let config = {
            profile: {
                name: '@username',
                bio: 'وصف قصير عنك يظهر هنا!',
                avatar: 'https://via.placeholder.com/100',
            },
            socials: {
                twitter: '',
                instagram: '',
                facebook: '',
                tiktok: '',
                youtube: '',
                linkedin: '',
                github: ''
            },
            links: [
                { title: 'موقعي الإلكتروني', url: '#' },
                { title: 'صفحتي على فيسبوك', url: '#' },
            ],
            design: {
                theme: 'light',
                bgColor: '#f0f0f0',
                linkBgColor: '#ffffff',
                linkTextColor: '#000000',
                textColor: '#000000',
                font: "'Cairo', sans-serif",
                buttonRadius: '8px'
            }
        };
        
        // --- الثيمات الجاهزة ---
        const themes = {
            'light': { bgColor: '#f0f2f5', linkBgColor: '#ffffff', linkTextColor: '#1c1e21', textColor: '#1c1e21' },
            'dark': { bgColor: '#18191a', linkBgColor: '#3a3b3c', linkTextColor: '#e4e6eb', textColor: '#e4e6eb' },
            'gradient-pink': { bgColor: 'linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%)', linkBgColor: '#ffffff', linkTextColor: '#333', textColor: '#333' },
            'gradient-blue': { bgColor: 'linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%)', linkBgColor: 'rgba(255,255,255,0.8)', linkTextColor: '#222', textColor: '#222' },
            'forest': { bgColor: '#2c3e50', linkBgColor: '#27ae60', linkTextColor: '#ffffff', textColor: '#ecf0f1' }
        };

        // --- الوظائف الرئيسية ---
        function renderPreview() {
            const { profile, links, socials, design } = config;

            // تطبيق التصميم
            elements.previewContent.style.background = design.bgColor;
            elements.previewContent.style.fontFamily = design.font;

            let socialsHTML = '';
            for (const [platform, username] of Object.entries(socials)) {
                if (username && socialIcons[platform]) {
                    const url = `https://www.${platform}.com/${username}`;
                    socialsHTML += `<a href="${url}" target="_blank" style="color: ${design.textColor}">${socialIcons[platform]}</a>`;
                }
            }

            let linksHTML = links.map(link => 
                `<a href="${link.url}" target="_blank" style="background-color: ${design.linkBgColor}; color: ${design.linkTextColor}; border-radius: ${design.buttonRadius};">${link.title}</a>`
            ).join('');

            elements.previewContent.innerHTML = `
                <img src="${profile.avatar}" alt="Avatar" class="preview-avatar">
                <h2 class="preview-name" style="color: ${design.textColor};">${profile.name}</h2>
                <p class="preview-bio" style="color: ${design.textColor};">${profile.bio}</p>
                <div class="preview-socials">${socialsHTML}</div>
                <div class="preview-links">${linksHTML}</div>
            `;
        }

        function updateUIFromConfig() {
            const { profile, links, socials, design } = config;
            elements.profileName.value = profile.name;
            elements.profileBio.value = profile.bio;
            elements.profileAvatar.value = profile.avatar;
            
            elements.themeSelector.value = design.theme;
            elements.bgColorPicker.value = design.bgColor;
            elements.linkBgColorPicker.value = design.linkBgColor;
            elements.linkTextColorPicker.value = design.linkTextColor;
            elements.textColorPicker.value = design.textColor;
            elements.fontSelector.value = design.font;
            elements.buttonStyleSelector.value = design.buttonRadius;
            
            renderSocialLinksEditor();
            renderLinksEditor();
        }

        function renderSocialLinksEditor() {
            elements.socialLinksList.innerHTML = '';
            socialPlatforms.forEach(platform => {
                const item = document.createElement('div');
                item.className = 'form-group';
                item.innerHTML = `
                    <label for="social-${platform}">${platform.charAt(0).toUpperCase() + platform.slice(1)} Username</label>
                    <input type="text" id="social-${platform}" placeholder="${platform}_username" value="${config.socials[platform] || ''}">
                `;
                item.querySelector('input').addEventListener('input', (e) => {
                    config.socials[platform] = e.target.value;
                    saveAndRender();
                });
                elements.socialLinksList.appendChild(item);
            });
        }

        function renderLinksEditor() {
            elements.linksList.innerHTML = '';
            config.links.forEach((link, index) => {
                const item = document.createElement('div');
                item.className = 'link-item';
                item.draggable = true;
                item.dataset.index = index;
                item.innerHTML = `
                    <span class="drag-handle">☰</span>
                    <div class="link-inputs">
                        <input type="text" class="link-title" placeholder="عنوان الرابط" value="${link.title}">
                        <input type="url" class="link-url" placeholder="https://example.com" value="${link.url}">
                    </div>
                    <button class="btn btn-danger delete-link-btn">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41z"></path></svg>
                    </button>
                `;
                elements.linksList.appendChild(item);
            });
        }
        
        function saveConfig() {
            try {
                localStorage.setItem('smartLinkConfig', JSON.stringify(config));
            } catch (e) {
                console.error("Could not save to localStorage", e);
            }
        }
        
        function loadConfig() {
            try {
                const savedConfig = localStorage.getItem('smartLinkConfig');
                if (savedConfig) {
                    config = JSON.parse(savedConfig);
                }
            } catch(e) {
                console.error("Could not load from localStorage", e);
            }
        }

        function saveAndRender() {
            saveConfig();
            renderPreview();
        }

        function generateShareableLink() {
            const dataStr = JSON.stringify(config);
            const encodedData = btoa(dataStr);
            const baseURL = window.location.href.split('#')[0];
            return `${baseURL}#data=${encodedData}`;
        }
        
        function generateFinalHTML(data) {
            const { profile, links, socials, design } = data;
            
            let socialsHTML = '';
            for (const [platform, username] of Object.entries(socials)) {
                if (username && socialIcons[platform]) {
                    const url = `https://www.${platform}.com/${username}`;
                    socialsHTML += `<a href="${url}" target="_blank" class="social-icon" style="color: ${design.textColor}">${socialIcons[platform]}</a>`;
                }
            }

            let linksHTML = links.map(link =>
                `<a href="${link.url}" target="_blank" class="link-btn" style="background-color: ${design.linkBgColor}; color: ${design.linkTextColor}; border-radius: ${design.buttonRadius};">${link.title}</a>`
            ).join('');
            
            return `
                <style>
                    body {
                        margin: 0;
                        font-family: ${design.font};
                        background: ${design.bgColor};
                        color: ${design.textColor};
                        display: flex;
                        justify-content: center;
                        align-items: flex-start;
                        min-height: 100vh;
                        padding: 40px 15px;
                        box-sizing: border-box;
                    }
                    .page-container {
                        width: 100%;
                        max-width: 680px;
                        text-align: center;
                    }
                    .avatar {
                        width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
                        margin: 0 auto 15px; border: 4px solid rgba(255,255,255,0.5);
                    }
                    .name { font-size: 22px; font-weight: 900; margin: 0 0 8px; }
                    .bio { font-size: 15px; margin: 0 auto 20px; max-width: 90%; }
                    .social-icons-container { margin-bottom: 20px; display: flex; justify-content: center; gap: 15px; }
                    .social-icon { font-size: 24px; text-decoration: none; transition: transform 0.2s; }
                    .social-icon:hover { transform: scale(1.1); }
                    .links-container .link-btn {
                        display: block; background: ${design.linkBgColor}; color: ${design.linkTextColor};
                        padding: 15px; margin: 0 auto 15px; text-decoration: none;
                        font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s;
                    }
                    .links-container .link-btn:hover { transform: scale(1.03); }
                </style>
                <div class="page-container">
                    <img src="${profile.avatar}" alt="Avatar" class="avatar">
                    <h1 class="name">${profile.name}</h1>
                    <p class="bio">${profile.bio}</p>
                    <div class="social-icons-container">${socialsHTML}</div>
                    <div class="links-container">${linksHTML}</div>
                </div>
            `;
        }

        // --- ربط الأحداث ---
        [elements.profileName, elements.profileBio, elements.profileAvatar].forEach(el => {
            el.addEventListener('input', (e) => {
                config.profile[e.target.id.split('-')[1]] = e.target.value;
                saveAndRender();
            });
        });
        
        elements.addLinkBtn.addEventListener('click', () => {
            config.links.push({ title: 'رابط جديد', url: '#' });
            renderLinksEditor();
            saveAndRender();
        });

        elements.linksList.addEventListener('click', (e) => {
            if (e.target.closest('.delete-link-btn')) {
                const item = e.target.closest('.link-item');
                const index = parseInt(item.dataset.index);
                config.links.splice(index, 1);
                renderLinksEditor();
                saveAndRender();
            }
        });

        elements.linksList.addEventListener('input', (e) => {
            const item = e.target.closest('.link-item');
            const index = parseInt(item.dataset.index);
            if (e.target.classList.contains('link-title')) {
                config.links[index].title = e.target.value;
            } else if (e.target.classList.contains('link-url')) {
                config.links[index].url = e.target.value;
            }
            saveAndRender();
        });

        // Drag and Drop Logic
        let draggedItem = null;
        elements.linksList.addEventListener('dragstart', (e) => {
            draggedItem = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);
        });
        elements.linksList.addEventListener('dragend', (e) => {
            e.target.classList.remove('dragging');
            
            const newOrder = Array.from(elements.linksList.children).map(item => {
                return config.links[parseInt(item.dataset.index)];
            });
            config.links = newOrder;
            renderLinksEditor();
            saveAndRender();
        });
        elements.linksList.addEventListener('dragover', (e) => {
            e.preventDefault();
            const afterElement = getDragAfterElement(elements.linksList, e.clientY);
            if (afterElement == null) {
                elements.linksList.appendChild(draggedItem);
            } else {
                elements.linksList.insertBefore(draggedItem, afterElement);
            }
        });

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.link-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }


        // Design listeners
        elements.themeSelector.addEventListener('change', (e) => {
            const themeName = e.target.value;
            config.design.theme = themeName;
            if (themes[themeName]) {
                const theme = themes[themeName];
                config.design.bgColor = theme.bgColor;
                config.design.linkBgColor = theme.linkBgColor;
                config.design.linkTextColor = theme.linkTextColor;
                config.design.textColor = theme.textColor;
                updateUIFromConfig();
            }
            saveAndRender();
        });

        [elements.bgColorPicker, elements.linkBgColorPicker, elements.linkTextColorPicker, elements.textColorPicker].forEach(picker => {
            picker.addEventListener('input', (e) => {
                const key = e.target.id.replace('-color', 'Color').replace('-', '');
                config.design[key] = e.target.value;
                saveAndRender();
            });
        });
        
        elements.fontSelector.addEventListener('change', (e) => {
            config.design.font = e.target.value;
            saveAndRender();
        });
        
        elements.buttonStyleSelector.addEventListener('change', (e) => {
            config.design.buttonRadius = e.target.value;
            saveAndRender();
        });

        // Modal and Actions
        elements.generateLinkBtn.addEventListener('click', () => {
            const link = generateShareableLink();
            elements.generatedLinkInput.value = link;
            elements.modal.style.display = 'flex';
        });

        elements.downloadHtmlBtn.addEventListener('click', () => {
            const finalHTML = generateFinalHTML(config);
            const blob = new Blob([`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${config.profile.name}</title></head><body>${finalHTML}</body></html>`], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'index.html';
            a.click();
            URL.revokeObjectURL(url);
        });

        elements.closeModalBtn.addEventListener('click', () => {
            elements.modal.style.display = 'none';
        });

        elements.copyLinkBtn.addEventListener('click', () => {
            elements.generatedLinkInput.select();
            document.execCommand('copy');
            elements.copyLinkBtn.textContent = 'تم النسخ!';
            setTimeout(() => { elements.copyLinkBtn.textContent = 'نسخ الرابط'; }, 1500);
        });


        // --- التشغيل الأولي ---
        loadConfig();
        updateUIFromConfig();
        renderPreview();
    }

    </script>
</body>
</html>


