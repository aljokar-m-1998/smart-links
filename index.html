<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>M.H â€¢ English Sentences Game</title>
<style>
  :root{
    --bg:#0f1216;--panel:#151a21;--card:#1b212a;--text:#e7edf3;--muted:#9aa6b2;
    --brand:#3dd6c3;--accent:#7aa3ff;--danger:#ff6b6b;--ok:#31d0aa;--warn:#f4c96b;
    --border:#26303b;--ghost:#202733;--focus:#3dd6c34d;
    --bg-light:#f5f7fa;--panel-light:#ffffff;--card-light:#f9fafc;--text-light:#151922;--muted-light:#4a5160;--border-light:#d7dbe0;--ghost-light:#eef1f5;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:linear-gradient(180deg, #0a0d11, var(--bg));
    color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    transition:background .25s ease,color .25s ease
  }
  body.light{
    background:linear-gradient(180deg, #f0f2f6, var(--bg-light));
    color:var(--text-light)
  }
  a{color:inherit;text-decoration:none}
  button{cursor:pointer;background:var(--ghost);color:var(--text);border:1px solid var(--border);
    border-radius:10px;padding:.65rem .9rem;font-weight:600;transition:transform .12s ease, box-shadow .2s ease, opacity .2s ease}
  body.light button{background:var(--ghost-light);color:var(--text-light);border-color:var(--border-light)}
  button:active{transform:scale(.98)}
  button.ghost{background:transparent}
  button.primary{background:var(--accent);color:#0b1020;border-color:transparent}
  button.success{background:var(--ok);color:#061915;border-color:transparent}
  button.warn{background:var(--warn);color:#231a06;border-color:transparent}
  button.danger{background:var(--danger);color:#1a0606;border-color:transparent}
  button.icon{display:flex;align-items:center;gap:.5rem}
  button.nohover:hover{background:transparent;color:inherit}
  header{
    position:sticky;top:0;z-index:50;background:rgba(16,20,26,.85);backdrop-filter:saturate(140%) blur(12px);
    border-bottom:1px solid var(--border)
  }
  body.light header{background:rgba(255,255,255,.85);border-color:var(--border-light)}
  .wrap{max-width:1120px;margin:0 auto;padding:1rem}
  .brandbar{display:flex;align-items:center;justify-content:space-between;gap:1rem}
  .brand{display:flex;align-items:center;gap:.9rem}
  .mh{
    display:inline-flex;align-items:center;justify-content:center;
    width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg, var(--brand), #8af5e7);
    color:#0b1a17;font-weight:900;letter-spacing:.5px;border:2px solid #0b1a17;box-shadow:0 8px 24px #3dd6c344
  }
  .title h1{margin:0;font-size:1.3rem}
  .title p{margin:.2rem 0 0;color:var(--muted);font-size:.9rem}
  body.light .title p{color:var(--muted-light)}
  .actions{display:flex;flex-wrap:wrap;gap:.5rem}
  main{padding:1rem}
  .grid{display:grid;gap:1rem;grid-template-columns:1fr}
  @media(min-width:900px){.grid{grid-template-columns: 1.1fr .9fr}}
  .card{
    background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1rem;box-shadow:0 8px 24px rgba(0,0,0,.25)
  }
  body.light .card{background:var(--card-light);border-color:var(--border-light);box-shadow:0 10px 24px rgba(0,0,0,.08)}
  .card h3{margin:0 0 .8rem;font-size:1.05rem}
  .set-row{display:grid;gap:.6rem;grid-template-columns:1fr 1fr}
  .set-item{display:flex;flex-direction:column;gap:.4rem}
  .seg{display:flex;flex-wrap:wrap;gap:.5rem}
  select,input[type="number"],input[type="text"],input[type="range"]{
    background:#12161c;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:.55rem .7rem;outline:none
  }
  body.light select,body.light input[type="number"],body.light input[type="text"],body.light input[type="range"]{background:#ffffff;color:var(--text-light);border-color:var(--border-light)}
  select:focus,input:focus{box-shadow:0 0 0 3px var(--focus)}
  .stats{display:grid;grid-template-columns:repeat(5,1fr);gap:.5rem}
  .stat{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:.6rem;text-align:center}
  body.light .stat{background:var(--panel-light);border-color:var(--border-light)}
  .stat b{display:block;font-size:.8rem;color:var(--muted)}
  body.light .stat b{color:var(--muted-light)}
  .stat span{font-size:1.15rem;font-weight:800}
  .progress{margin-top:.7rem;height:10px;background:#10151b;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  body.light .progress{background:#eef1f5;border-color:var(--border-light)}
  .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg, var(--brand), var(--accent))}
  .top-progress{position:sticky;top:60px;height:4px;background:#0d1217}
  body.light .top-progress{background:#e7eaf0}
  .top-progress i{display:block;height:100%;width:0;background:linear-gradient(90deg, var(--brand), var(--accent))}
  .game{min-height:240px;display:flex;flex-direction:column;gap:1rem}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:1rem}
  body.light .panel{background:var(--panel-light);border-color:var(--border-light)}
  .fade-enter{opacity:.01;transform:translateY(6px)}
  .fade-enter.fade-enter-active{opacity:1;transform:none;transition:opacity .22s ease, transform .22s ease}
  .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.3rem .6rem;border-radius:999px;background:#0f141a;border:1px solid var(--border);color:var(--muted);font-size:.8rem}
  body.light .pill{background:#f7f9fb;border-color:var(--border-light);color:var(--muted-light)}
  .options{display:grid;gap:.5rem}
  .options button{justify-content:flex-start}
  .row{display:flex;align-items:center;gap:.6rem;flex-wrap:wrap}
  .space{flex:1}
  .note{color:var(--muted);font-size:.92rem}
  body.light .note{color:var(--muted-light)}
  .error{color:var(--danger)}
  .ok{color:var(--ok)}
  .list{display:flex;flex-direction:column;gap:.6rem;max-height:320px;overflow:auto}
  .footer{margin-top:.6rem;color:var(--muted);font-size:.85rem}
  .badge{padding:.25rem .5rem;border-radius:7px;background:#0e151c;border:1px solid var(--border);font-size:.8rem}
  body.light .badge{background:#eef1f5;border-color:var(--border-light)}
  .chip{padding:.25rem .5rem;border-radius:999px;background:#0f141a;border:1px solid var(--border);font-size:.8rem}
  body.light .chip{background:#f7f9fb;border-color:var(--border-light)}
  .center{display:flex;align-items:center;justify-content:center}
  .correct{background:var(--ok)!important;color:#07140f!important;border-color:transparent!important}
  .wrong{background:var(--danger)!important;color:#1a0606!important;border-color:transparent!important}
</style>
</head>
<body>
<header>
  <div class="wrap brandbar">
    <div class="brand">
      <div class="mh">M.H</div>
      <div class="title">
        <h1 id="appTitle">Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ù…Ù„ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</h1>
        <p>Mobile-first â€¢ Offline-ready â€¢ Modular</p>
      </div>
    </div>
    <div class="actions">
      <button id="langBtn" class="ghost nohover icon"><span>ğŸŒ</span><span id="langLabel">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span></button>
      <button id="themeBtn" class="icon"><span>ğŸŒ“</span><span id="themeLabel">Ø§Ù„Ù…Ø¸Ù‡Ø±</span></button>
      <button id="ttsTest" class="icon"><span>ğŸ”Š</span><span id="ttsLabel">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø·Ù‚</span></button>
      <button id="resetBtn" class="danger icon"><span>â†º</span><span id="resetLabel">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·</span></button>
      <input type="file" id="jsonLoader" accept=".json" style="display:none">
      <button id="loadJsonBtn" class="icon"><span>ğŸ“‚</span><span id="loadJsonLabel">ØªØ­Ù…ÙŠÙ„ JSON</span></button>
    </div>
  </div>
  <div class="top-progress"><i id="topProgressBar"></i></div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <h3 id="settingsTitle">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
      <div class="set-row">
        <div class="set-item">
          <b id="modeLabel">Ø§Ù„ÙˆØ¶Ø¹</b>
          <div class="seg" id="modeSeg"></div>
        </div>
        <div class="set-item">
          <b id="orderLabel">Ø§Ù„ØªØ±ØªÙŠØ¨</b>
          <div class="seg" id="orderSeg"></div>
        </div>
      </div>
      <div class="set-row" style="margin-top:.6rem">
        <div class="set-item">
          <b id="levelLabel">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</b>
          <select id="levelSel">
            <option value="All">All</option>
            <option value="A1">A1</option>
            <option value="A2">A2</option>
            <option value="B1">B1</option>
            <option value="B2">B2</option>
            <option value="C1">C1</option>
          </select>
        </div>
        <div class="set-item">
          <b id="topicLabel">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</b>
          <select id="topicSel"><option value="All">All</option></select>
        </div>
      </div>
      <div class="panel" style="margin-top:.8rem">
        <div class="row">
          <span class="note" id="loadNote">ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</span>
          <span class="space"></span>
          <span id="loadCount" class="badge">0</span>
        </div>
      </div>
      <div class="panel" style="margin-top:.8rem">
        <div class="stats">
          <div class="stat"><b id="totalLabel">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</b><span id="statTotal">0</span></div>
          <div class="stat"><b id="correctLabel">Ø§Ù„ØµØ­ÙŠØ­</b><span id="statCorrect">0</span></div>
          <div class="stat"><b id="streakLabel">Ø³Ù„Ø³Ù„Ø©</b><span id="statStreak">0</span></div>
          <div class="stat"><b id="seenLabel">Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</b><span id="statSeen">0</span></div>
          <div class="stat"><b id="favLabel">Ø§Ù„Ù…ÙØ¶Ù„Ø©</b><span id="statFav">0</span></div>
        </div>
        <div class="progress"><i id="progressBar"></i></div>
      </div>
      <div class="panel" style="margin-top:.8rem">
        <div class="row">
          <b id="challengeTitle">Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª</b>
          <span class="space"></span>
          <label class="chip"><span id="challengeLevelLabel">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</span>
            <select id="challengeLevel" style="margin-inline-start:.4rem">
              <option value="All">All</option>
              <option value="A1">A1</option><option value="A2">A2</option>
              <option value="B1">B1</option><option value="B2">B2</option><option value="C1">C1</option>
            </select>
          </label>
          <label class="chip"><span id="challengeCountLabel">Ø§Ù„Ø¹Ø¯Ø¯</span>
            <input id="challengeCount" type="number" min="1" max="50" value="10" style="width:80px;margin-inline-start:.4rem">
          </label>
          <button id="startChallenge" class="primary icon"><span>ğŸ</span><span id="startChallengeLabel">Ø§Ø¨Ø¯Ø£</span></button>
        </div>
        <div class="footer" id="challengeStatus">Ø¬Ø§Ù‡Ø²</div>
      </div>
      <div class="panel" style="margin-top:.8rem">
        <div class="row">
          <b id="audioTitle">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª</b>
          <span class="space"></span>
          <label class="chip"><span id="voiceLabel">Ø§Ù„ØµÙˆØª</span>
            <select id="voiceSel" style="margin-inline-start:.4rem"></select>
          </label>
          <label class="chip"><span id="rateLabel">Ø§Ù„Ø³Ø±Ø¹Ø©</span>
            <input id="rateRange" type="range" min="0.6" max="1.4" step="0.1" value="1" style="width:120px;margin-inline-start:.4rem">
          </label>
          <label class="chip"><span id="repeatLabel">Ø§Ù„ØªÙƒØ±Ø§Ø±</span>
            <input id="repeatRange" type="range" min="1" max="3" step="1" value="1" style="width:120px;margin-inline-start:.4rem">
          </label>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 id="gameTitle">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©</h3>
      <div id="gameArea" class="game"></div>
      <div class="panel">
        <b id="historyTitle">Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª</b>
        <div id="historyList" class="list"></div>
      </div>
    </section>
  </div>
</main>

<script>
  const I18N = {
    ar:{
      appTitle:"Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ù…Ù„ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", langLabel:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", ttsLabel:"Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø·Ù‚", resetLabel:"Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·",
      settingsTitle:"Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", modeLabel:"Ø§Ù„ÙˆØ¶Ø¹", orderLabel:"Ø§Ù„ØªØ±ØªÙŠØ¨", levelLabel:"Ø§Ù„Ù…Ø³ØªÙˆÙ‰", topicLabel:"Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹",
      loadNote_loading:"ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...", loadNote_ok:"ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­", loadNote_fail:"ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©",
      totalLabel:"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹", correctLabel:"Ø§Ù„ØµØ­ÙŠØ­", streakLabel:"Ø³Ù„Ø³Ù„Ø©", seenLabel:"Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª", favLabel:"Ø§Ù„Ù…ÙØ¶Ù„Ø©",
      challengeTitle:"Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª", challengeLevelLabel:"Ø§Ù„Ù…Ø³ØªÙˆÙ‰", challengeCountLabel:"Ø§Ù„Ø¹Ø¯Ø¯", startChallengeLabel:"Ø§Ø¨Ø¯Ø£",
      challengeReady:"Ø¬Ø§Ù‡Ø²", challengeRunning:"ØªØ­Ø¯ÙŠ Ø¬Ø§Ø±Ù", challengeDone:"Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ",
      gameTitle:"Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©", historyTitle:"Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª",
      audioTitle:"Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª", voiceLabel:"Ø§Ù„ØµÙˆØª", rateLabel:"Ø§Ù„Ø³Ø±Ø¹Ø©", repeatLabel:"Ø§Ù„ØªÙƒØ±Ø§Ø±",
      modes:["Study","MCQ","Typing","Listen","Mix"],
      orders:["Sequential","Shuffle","Least Seen"],
      study_en:"Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", study_ar:"Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
      speak:"Ù†Ø·Ù‚", favorite:"Ù…ÙØ¶Ù„Ø©", next:"Ø§Ù„ØªØ§Ù„ÙŠ",
      choose_correct:"Ø§Ø®ØªØ± Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©",
      type_english:"Ø§ÙƒØªØ¨ Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù‡Ù†Ø§",
      listen_instructions:"Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ù†Ø·Ù‚ Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©",
      tts_ready:"Ø§Ù„Ù†Ø·Ù‚ Ø¬Ø§Ù‡Ø²", tts_not_ready:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙˆØ§Øª Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù…ØªØ§Ø­Ø©ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ",
      reset_confirm:"Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ", reset_done:"ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·",
      empty_data:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹Ø±ÙˆØ¶Ø© Ø­Ø§Ù„ÙŠØ§Ù‹",
      challenge_progress:"ØªÙ‚Ø¯Ù… Ø§Ù„ØªØ­Ø¯ÙŠ",
      correct:"ØµØ­ÙŠØ­", wrong:"Ø®Ø·Ø£",
      seen_badge:"Ù…Ø´Ø§Ù‡Ø¯Ø§Øª", level_badge:"Ø§Ù„Ù…Ø³ØªÙˆÙ‰", topic_badge:"Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹",
      themeLabel:"Ø§Ù„Ù…Ø¸Ù‡Ø±", loadJsonLabel:"ØªØ­Ù…ÙŠÙ„ JSON",
      replace_merge_prompt:"Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ù… Ø¯Ù…Ø¬Ù‡Ø§ØŸ Ø§Ø®ØªØ± OK Ù„Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙˆCancel Ù„Ù„Ø¯Ù…Ø¬.",
    },
    en:{
      appTitle:"English Sentences Game", langLabel:"English", ttsLabel:"TTS Test", resetLabel:"Reset",
      settingsTitle:"Settings", modeLabel:"Mode", orderLabel:"Order", levelLabel:"Level", topicLabel:"Topic",
      loadNote_loading:"Loading data...", loadNote_ok:"Loaded successfully", loadNote_fail:"Failed to load local data",
      totalLabel:"Total", correctLabel:"Correct", streakLabel:"Streak", seenLabel:"Seen", favLabel:"Favorites",
      challengeTitle:"Challenges", challengeLevelLabel:"Level", challengeCountLabel:"Count", startChallengeLabel:"Start",
      challengeReady:"Ready", challengeRunning:"Challenge running", challengeDone:"Challenge completed",
      gameTitle:"Game area", historyTitle:"Challenge history",
      audioTitle:"Audio settings", voiceLabel:"Voice", rateLabel:"Rate", repeatLabel:"Repeat",
      modes:["Study","MCQ","Typing","Listen","Mix"],
      orders:["Sequential","Shuffle","Least Seen"],
      study_en:"English sentence", study_ar:"Arabic translation",
      speak:"Speak", favorite:"Favorite", next:"Next",
      choose_correct:"Choose the correct translation",
      type_english:"Type the English sentence here",
      listen_instructions:"Listen, then choose the correct translation",
      tts_ready:"TTS ready", tts_not_ready:"No English voices available, fallback will be used",
      reset_confirm:"Do you want to clear all data?", reset_done:"Reset complete",
      empty_data:"No data to show yet",
      challenge_progress:"Challenge progress",
      correct:"Correct", wrong:"Wrong",
      seen_badge:"Seen", level_badge:"Level", topic_badge:"Topic",
      themeLabel:"Theme", loadJsonLabel:"Load JSON",
      replace_merge_prompt:"Replace data or merge? OK = Replace, Cancel = Merge."
    }
  };

  const store = {
    get(k, def){try{const v=localStorage.getItem(k);return v?JSON.parse(v):def}catch{ return def}},
    set(k, v){localStorage.setItem(k, JSON.stringify(v))},
    del(k){localStorage.removeItem(k)}
  };

  const KEYS = {
    settings:"mh_settings",
    progress:"mh_progress",
    seen:"mh_seen",
    favs:"mh_favs",
    history:"mh_challenges",
    lang:"mh_lang",
    theme:"mh_theme",
    audio:"mh_audio"
  };

  const state = {
    lang: store.get(KEYS.lang, "ar"),
    theme: store.get(KEYS.theme, "dark"),
    voices:[],
    voice:null,
    audio: store.get(KEYS.audio, {rate:1, repeat:1}),
    data:[],
    filtered:[],
    topics:["All"],
    index:0,
    current:null,
    settings: store.get(KEYS.settings, {mode:"Study", order:"Sequential", level:"All", topic:"All"}),
    progress: store.get(KEYS.progress, {total:0, correct:0, streak:0, seen:0}),
    seenMap: store.get(KEYS.seen, {}),
    favs: new Set(store.get(KEYS.favs, [])),
    challenge:{ active:false, level:"All", total:0, current:0, correct:0, list:[] },
    history: store.get(KEYS.history, [])
  };

  const $ = sel => document.querySelector(sel);

  function applyLang(){
    const t = I18N[state.lang];
    document.documentElement.lang = state.lang;
    document.documentElement.dir = (state.lang==="ar")?"rtl":"ltr";
    $("#appTitle").textContent = t.appTitle;
    $("#langLabel").textContent = t.langLabel;
    $("#ttsLabel").textContent = t.ttsLabel;
    $("#resetLabel").textContent = t.resetLabel;
    $("#settingsTitle").textContent = t.settingsTitle;
    $("#modeLabel").textContent = t.modeLabel;
    $("#orderLabel").textContent = t.orderLabel;
    $("#levelLabel").textContent = t.levelLabel;
    $("#topicLabel").textContent = t.topicLabel;
    $("#loadNote").textContent = t.loadNote_loading;
    $("#totalLabel").textContent = t.totalLabel;
    $("#correctLabel").textContent = t.correctLabel;
    $("#streakLabel").textContent = t.streakLabel;
    $("#seenLabel").textContent = t.seenLabel;
    $("#favLabel").textContent = t.favLabel;
    $("#challengeTitle").textContent = t.challengeTitle;
    $("#challengeLevelLabel").textContent = t.challengeLevelLabel;
    $("#challengeCountLabel").textContent = t.challengeCountLabel;
    $("#startChallengeLabel").textContent = t.startChallengeLabel;
    $("#challengeStatus").textContent = t.challengeReady;
    $("#gameTitle").textContent = t.gameTitle;
    $("#historyTitle").textContent = t.historyTitle;
    $("#audioTitle").textContent = t.audioTitle;
    $("#voiceLabel").textContent = t.voiceLabel;
    $("#rateLabel").textContent = t.rateLabel;
    $("#repeatLabel").textContent = t.repeatLabel;
    $("#themeLabel").textContent = t.themeLabel;
    $("#loadJsonLabel").textContent = t.loadJsonLabel;
    renderModeSeg(); renderOrderSeg();
  }

  function applyTheme(){
    document.body.classList.toggle("light", state.theme==="light");
  }

  function renderModeSeg(){
    const t = I18N[state.lang].modes;
    const wrap = $("#modeSeg"); wrap.innerHTML="";
    t.forEach(m=>{
      const b = document.createElement("button");
      b.textContent=m; b.className="chip"; if(state.settings.mode===m) b.style.borderColor="var(--brand)";
      b.onclick=()=>{state.settings.mode=m; persist("settings"); resetMixStage(); refreshFiltered(); goCurrent(state.index);};
      wrap.appendChild(b);
    });
  }
  function renderOrderSeg(){
    const t = I18N[state.lang].orders;
    const wrap = $("#orderSeg"); wrap.innerHTML="";
    t.forEach(o=>{
      const b = document.createElement("button");
      b.textContent=o; b.className="chip"; if(state.settings.order===o) b.style.borderColor="var(--brand)";
      b.onclick=()=>{state.settings.order=o; persist("settings"); buildOrder(); goCurrent(0);};
      wrap.appendChild(b);
    });
  }

  function persist(type){
    if(type==="settings") store.set(KEYS.settings, state.settings);
    if(type==="progress") store.set(KEYS.progress, state.progress);
    if(type==="seen") store.set(KEYS.seen, state.seenMap);
    if(type==="favs") store.set(KEYS.favs, Array.from(state.favs));
    if(type==="history") store.set(KEYS.history, state.history.slice(-50));
    if(type==="lang") store.set(KEYS.lang, state.lang);
    if(type==="theme") store.set(KEYS.theme, state.theme);
    if(type==="audio") store.set(KEYS.audio, state.audio);
    updateStats();
  }

  function computeId(item){ return (item.en||"")+"__"+(item.ar||"") }

  function validateItem(x){
    if(!x || typeof x!=="object") return null;
    if(!x.en || !x.ar) return null;
    const y = {en:String(x.en), ar:String(x.ar), topic:(x.topic||"general"), level:(x.level||"A1"), tags:Array.isArray(x.tags)?x.tags:[]};
    return y;
  }

  async function loadData(){
    $("#loadNote").textContent = I18N[state.lang].loadNote_loading;
    try{
      const res = await fetch('./sentences.json');
      if(!res.ok) throw new Error("fetch failed");
      const arr = await res.json();
      const valid = [];
      for(const it of (Array.isArray(arr)?arr:[])){
        const v = validateItem(it);
        if(v) valid.push(v);
      }
      state.data = valid;
      $("#loadCount").textContent = String(valid.length);
      $("#loadNote").innerHTML = `<span class="ok">${I18N[state.lang].loadNote_ok}</span>`;
      collectTopics(); refreshFiltered(); buildOrder(); goCurrent(0);
    }catch(e){
      $("#loadNote").innerHTML = `<span class="error">${I18N[state.lang].loadNote_fail}</span>`;
      $("#loadCount").textContent="0";
      collectTopics(); refreshFiltered(); buildOrder(); renderGameEmpty();
    }
  }

  function loadFromFile(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const arr = JSON.parse(reader.result);
        const valid = [];
        for(const it of (Array.isArray(arr)?arr:[])){
          const v = validateItem(it);
          if(v) valid.push(v);
        }
        const replace = confirm(I18N[state.lang].replace_merge_prompt);
        if(replace){
          state.data = valid;
        }else{
          const map = new Map(state.data.map(d=>[computeId(d), d]));
          valid.forEach(v=>map.set(computeId(v), v));
          state.data = Array.from(map.values());
        }
        $("#loadCount").textContent = String(state.data.length);
        collectTopics(); refreshFiltered(); buildOrder(); goCurrent(0);
      }catch(err){
        alert("Invalid JSON file");
      }
    };
    reader.readAsText(file);
  }

  function collectTopics(){
    const set = new Set(["All"]);
    state.data.forEach(d=>set.add(d.topic||"general"));
    state.topics = Array.from(set);
    const sel = $("#topicSel"); sel.innerHTML="";
    for(const t of state.topics){ const o=document.createElement("option"); o.value=t; o.textContent=t; sel.appendChild(o); }
    sel.value = state.settings.topic || "All";
  }

  function refreshFiltered(){
    const level = state.settings.level;
    const topic = state.settings.topic;
    let list = state.data.slice();
    if(level && level!=="All") list = list.filter(x=>x.level===level);
    if(topic && topic!=="All") list = list.filter(x=>x.topic===topic);
    state.filtered = list;
    state.progress.total = list.length;
    persist("progress");
    updateStats();
  }

  function buildOrder(){
    const order = state.settings.order;
    const list = state.filtered.slice();
    if(order==="Shuffle"){
      for(let i=list.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[list[i],list[j]]=[list[j],list[i]];}
    }else if(order==="Least Seen"){
      list.sort((a,b)=>{
        const sa = state.seenMap[computeId(a)]||0;
        const sb = state.seenMap[computeId(b)]||0;
        if(sa!==sb) return sa-sb;
        return 0;
      });
    }
    state.filtered = list;
  }

  function goCurrent(idx){
    state.index = Math.max(0, Math.min(idx, state.filtered.length-1));
    state.current = state.filtered[state.index] || null;
    if(state.current){ trackSeen(state.current); }
    renderGame();
    autoSpeakCurrent();
  }

  function trackSeen(item){
    const id = computeId(item);
    state.seenMap[id] = (state.seenMap[id]||0) + 1;
    state.progress.seen = Object.values(state.seenMap).reduce((a,b)=>a+b,0);
    persist("seen"); persist("progress");
  }

  function updateStats(){
    $("#statTotal").textContent = String(state.progress.total||0);
    $("#statCorrect").textContent = String(state.progress.correct||0);
    $("#statStreak").textContent = String(state.progress.streak||0);
    $("#statSeen").textContent = String(state.progress.seen||0);
    $("#statFav").textContent = String(state.favs.size||0);
    const p = state.challenge.active && state.challenge.total>0 ? Math.round(100*state.challenge.current/state.challenge.total) : 0;
    $("#progressBar").style.width = p+"%";
    $("#topProgressBar").style.width = p+"%";
  }

  function renderGame(){
    const area = $("#gameArea"); area.innerHTML="";
    if(!state.current){
      renderGameEmpty();
      return;
    }
    const mode = state.settings.mode;
    if(state.challenge.active){
      $("#challengeStatus").textContent = I18N[state.lang].challengeRunning + ` â€¢ ${state.challenge.current}/${state.challenge.total}`;
    }
    if(mode==="Study") renderStudy(area, state.current);
    else if(mode==="MCQ") renderMCQ(area, state.current);
    else if(mode==="Typing") renderTyping(area, state.current);
    else if(mode==="Listen") renderListen(area, state.current);
    else if(mode==="Mix") renderMix(area, state.current);
  }

  function renderGameEmpty(){
    const area = $("#gameArea");
    const p = document.createElement("div"); p.className="panel center fade-enter fade-enter-active";
    p.innerHTML = `<div class="note">${I18N[state.lang].empty_data}</div>`;
    area.appendChild(p);
  }

  function badgeRow(item){
    return `
      <div class="row">
        <span class="pill">â­ ${I18N[state.lang].level_badge}: ${item.level}</span>
        <span class="pill">ğŸ·ï¸ ${I18N[state.lang].topic_badge}: ${item.topic}</span>
        <span class="pill">ğŸ‘ï¸ ${I18N[state.lang].seen_badge}: ${state.seenMap[computeId(item)]||0}</span>
      </div>
    `;
  }

  function renderStudy(area, item){
    const panel = document.createElement("div"); panel.className="panel fade-enter";
    panel.innerHTML = `
      <div class="row">
        <span class="badge">EN</span>
        <div class="space"></div>
        <button class="icon" id="favBtn"><span>â­</span><span>${I18N[state.lang].favorite}</span></button>
        <button class="primary icon" id="nextBtn"><span>â¡ï¸</span><span>${I18N[state.lang].next}</span></button>
      </div>
      <h2 style="margin:.6rem 0 0">${escapeHtml(item.en)}</h2>
      <div class="note" style="margin:.3rem 0 0">${I18N[state.lang].study_ar}</div>
      <h3 style="margin:.2rem 0 0;color:#b8c4cf">${escapeHtml(item.ar)}</h3>
      ${badgeRow(item)}
    `;
    area.appendChild(panel); requestAnimationFrame(()=>panel.classList.add("fade-enter-active"));
    $("#favBtn").onclick=()=> toggleFav(item);
    $("#nextBtn").onclick=()=> nextItem();
  }

  function gatherDistractors(correctItem, count){
    const pool = state.filtered.filter(x=>computeId(x)!==computeId(correctItem));
    const options = [];
    const seenAr = new Set();
    while(options.length<count && pool.length){
      const idx = Math.floor(Math.random()*pool.length);
      const cand = pool.splice(idx,1)[0];
      if(!seenAr.has(cand.ar)){ seenAr.add(cand.ar); options.push(cand.ar); }
    }
    return options;
  }

  function renderMCQ(area, item){
    const correct = item.ar;
    const distractors = gatherDistractors(item, 3);
    const opts = [correct, ...distractors].slice(0,4);
    shuffleArray(opts);
    const panel = document.createElement("div"); panel.className="panel fade-enter";
    panel.innerHTML = `
      <div class="row">
        <span class="badge">EN</span>
        <span class="space"></span><span class="chip">${I18N[state.lang].choose_correct}</span>
      </div>
      <h2 style="margin:.6rem 0">${escapeHtml(item.en)}</h2>
      <div class="options" id="opts"></div>
      ${badgeRow(item)}
    `;
    area.appendChild(panel); requestAnimationFrame(()=>panel.classList.add("fade-enter-active"));
    const wrap = $("#opts");
    const buttons=[];
    opts.forEach(o=>{
      const b = document.createElement("button"); b.className="ghost";
      b.textContent = o;
      b.onclick = ()=> {
        playClick();
        const ok = (o===correct);
        if(ok){
          b.classList.add("correct"); playCorrect();
          recordAnswer(true);
          setTimeout(()=> nextItem(), 450);
        }else{
          b.classList.add("wrong"); playWrong();
          recordAnswer(false);
          const correctBtn = buttons.find(x=>x.textContent===correct);
          if(correctBtn) correctBtn.classList.add("correct");
          buttons.forEach(x=>x.disabled=true);
          setTimeout(()=> nextItem(), 850);
        }
      };
      wrap.appendChild(b); buttons.push(b);
    });
  }

  function renderTyping(area, item){
    const panel = document.createElement("div"); panel.className="panel fade-enter";
    panel.innerHTML = `
      <div class="row">
        <span class="badge">AR</span><span class="chip">${I18N[state.lang].type_english}</span>
        <span class="space"></span><button class="icon" id="favBtn"><span>â­</span><span>${I18N[state.lang].favorite}</span></button>
      </div>
      <h3 style="margin:.4rem 0;color:#b8c4cf">${escapeHtml(item.ar)}</h3>
      <input id="typeInput" type="text" placeholder="${I18N[state.lang].type_english}" />
      <div class="row" style="margin-top:.6rem">
        <button class="success icon" id="submitBtn"><span>âœ…</span><span>${I18N[state.lang].next}</span></button>
      </div>
      ${badgeRow(item)}
    `;
    area.appendChild(panel); requestAnimationFrame(()=>panel.classList.add("fade-enter-active"));
    $("#favBtn").onclick=()=> toggleFav(item);
    $("#submitBtn").onclick=()=>{
      playClick();
      const val = normalizeText($("#typeInput").value);
      const target = normalizeText(item.en);
      const ok = (val===target);
      recordAnswer(ok);
      const btn = $("#submitBtn");
      btn.classList.remove("success"); btn.classList.add(ok?"correct":"wrong");
      ok ? playCorrect() : playWrong();
      setTimeout(()=> nextItem(), ok?450:850);
    };
  }

  function renderListen(area, item){
    const correct = item.ar;
    const distractors = gatherDistractors(item, 3);
    const opts = [correct, ...distractors].slice(0,4);
    shuffleArray(opts);
    const panel = document.createElement("div"); panel.className="panel fade-enter";
    panel.innerHTML = `
      <div class="row">
        <span class="badge">ğŸ”Š</span><span class="chip">${I18N[state.lang].listen_instructions}</span>
        <span class="space"></span>
      </div>
      <div class="options" id="opts"></div>
      ${badgeRow(item)}
    `;
    area.appendChild(panel); requestAnimationFrame(()=>panel.classList.add("fade-enter-active"));
    const wrap = $("#opts");
    const buttons=[];
    opts.forEach(o=>{
      const b = document.createElement("button"); b.className="ghost";
      b.textContent = o;
      b.onclick = ()=> {
        playClick();
        const ok = (o===correct);
        if(ok){
          b.classList.add("correct"); playCorrect();
          recordAnswer(true);
          setTimeout(()=> nextItem(), 450);
        }else{
          b.classList.add("wrong"); playWrong();
          recordAnswer(false);
          const correctBtn = buttons.find(x=>x.textContent===correct);
          if(correctBtn) correctBtn.classList.add("correct");
          buttons.forEach(x=>x.disabled=true);
          setTimeout(()=> nextItem(), 850);
        }
      };
      wrap.appendChild(b); buttons.push(b);
    });
  }

  const mixStageOrder = ["Study","MCQ","Typing","Listen"];
  let mixStageIndex = 0;
  function resetMixStage(){ mixStageIndex = 0; }
  function renderMix(area, item){
    const stage = mixStageOrder[mixStageIndex];
    const head = document.createElement("div");
    head.className="row"; head.innerHTML = `<span class="chip">Mix â€¢ ${stage}</span><span class="space"></span>`;
    area.appendChild(head);
    if(stage==="Study") renderStudy(area, item);
    else if(stage==="MCQ") renderMCQ(area, item);
    else if(stage==="Typing") renderTyping(area, item);
    else if(stage==="Listen") renderListen(area, item);
  }

  function nextItem(){
    if(state.settings.mode==="Mix"){
      mixStageIndex++;
      if(mixStageIndex < mixStageOrder.length){
        renderGame();
        autoSpeakCurrent();
        return;
      }
      mixStageIndex = 0;
    }
    const nextIdx = state.index + 1;
    if(state.challenge.active){
      state.challenge.current++;
      if(state.challenge.current >= state.challenge.total){
        finishChallenge();
        return;
      }
    }
    goCurrent(nextIdx >= state.filtered.length ? 0 : nextIdx);
  }

  function recordAnswer(ok){
    if(ok){
      state.progress.correct++;
      state.progress.streak++;
      if(state.challenge.active) state.challenge.correct++;
    }else{
      state.progress.streak = 0;
    }
    persist("progress");
  }

  function toggleFav(item){
    const id = computeId(item);
    if(state.favs.has(id)) state.favs.delete(id); else state.favs.add(id);
    persist("favs");
    renderGame();
  }

  function normalizeText(s){
    return String(s||"").trim().toLowerCase().replace(/\s+/g," ");
  }

  function shuffleArray(a){
    for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
  }

  function initVoice(){
    const pick = (voices)=>{
      state.voices = voices||[];
      state.voice = state.voices.find(v=>/en/i.test(v.lang)) || state.voices[0] || null;
      populateVoiceSel();
    };
    const ready = speechSynthesis.getVoices();
    if(ready && ready.length) pick(ready);
    speechSynthesis.onvoiceschanged = ()=> pick(speechSynthesis.getVoices());
  }

  function populateVoiceSel(){
    const sel = $("#voiceSel"); sel.innerHTML="";
    state.voices.forEach((v,i)=>{
      const o = document.createElement("option");
      o.value = i; o.textContent = `${v.name} (${v.lang})`;
      if(state.voice && v.name===state.voice.name) o.selected = true;
      sel.appendChild(o);
    });
  }

  function speak(text){
    if(!text) return;
    const u = new SpeechSynthesisUtterance(text);
    if(state.voice) u.voice = state.voice;
    u.lang = (state.voice?.lang)||"en-US";
    u.rate = Number(state.audio.rate)||1;
    speechSynthesis.cancel();
    const repeat = Math.max(1, Math.min(3, Number(state.audio.repeat)||1));
    for(let i=0;i<repeat;i++){ speechSynthesis.speak(u); }
  }

  function testTTS(){
    const ok = !!state.voice;
    const msg = ok ? I18N[state.lang].tts_ready : I18N[state.lang].tts_not_ready;
    $("#challengeStatus").textContent = msg;
  }

  function autoSpeakCurrent(){
    if(state.current) speak(state.current.en);
  }

  function startChallenge(){
    const level = $("#challengeLevel").value;
    const count = Math.max(1, Math.min(50, Number($("#challengeCount").value)||10));
    let list = state.data.slice();
    if(level!=="All") list = list.filter(x=>x.level===level);
    shuffleArray(list);
    state.challenge = { active:true, level, total: Math.min(count, list.length), current:0, correct:0, list: list.slice(0, count) };
    state.filtered = state.challenge.list.slice();
    buildOrder();
    $("#challengeStatus").textContent = I18N[state.lang].challengeRunning;
    goCurrent(0);
  }

  function finishChallenge(){
    state.challenge.active=false;
    const pct = state.challenge.total ? Math.round(100*state.challenge.correct/state.challenge.total) : 0;
    const entry = {
      ts: Date.now(),
      level: state.challenge.level,
      total: state.challenge.total,
      correct: state.challenge.correct,
      pct
    };
    state.history.push(entry);
    persist("history");
    $("#challengeStatus").textContent = I18N[state.lang].challengeDone + ` â€¢ ${pct}%`;
    refreshHistory();
    refreshFiltered(); buildOrder(); goCurrent(state.index);
  }

  function refreshHistory(){
    const list = $("#historyList"); list.innerHTML="";
    const arr = state.history.slice(-50).reverse();
    if(arr.length===0){
      const div=document.createElement("div"); div.className="note"; div.textContent="â€”";
      list.appendChild(div); return;
    }
    arr.forEach(h=>{
      const d = new Date(h.ts);
      const row = document.createElement("div"); row.className="row";
      const pct = Math.round(h.pct);
      row.innerHTML = `
        <span class="chip">${d.toLocaleString()}</span>
        <span class="chip">Lv: ${h.level}</span>
        <span class="chip">${h.correct}/${h.total} â€¢ ${pct}%</span>
      `;
      list.appendChild(row);
    });
  }

  function resetAll(){
    if(!confirm(I18N[state.lang].reset_confirm)) return;
    store.del(KEYS.settings); store.del(KEYS.progress); store.del(KEYS.seen);
    store.del(KEYS.favs); store.del(KEYS.history); store.del(KEYS.lang); store.del(KEYS.theme); store.del(KEYS.audio);
    state.lang="ar"; state.theme="dark"; state.settings={mode:"Study", order:"Sequential", level:"All", topic:"All"};
    state.progress={total:0, correct:0, streak:0, seen:0};
    state.seenMap={}; state.favs=new Set(); state.history=[]; state.challenge={active:false, level:"All", total:0, current:0, correct:0, list:[]};
    applyLang(); applyTheme(); collectTopics(); refreshFiltered(); buildOrder(); goCurrent(0); refreshHistory();
    $("#challengeStatus").textContent = I18N[state.lang].reset_done;
  }

  // WebAudio feedback tones
  let audioCtx = null;
  function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
  function beep(freq=440, dur=0.12, type="sine", vol=0.15){
    ensureAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type; osc.frequency.value = freq;
    gain.gain.value = vol;
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start();
    setTimeout(()=>{osc.stop();}, Math.round(dur*1000));
  }
  function playClick(){ beep(300,0.06,"triangle",0.12) }
  function playCorrect(){ beep(880,0.12,"sine",0.18); setTimeout(()=>beep(1320,0.1,"sine",0.16),120) }
  function playWrong(){ beep(180,0.12,"sawtooth",0.18); setTimeout(()=>beep(160,0.1,"sawtooth",0.16),110) }

  function initUI(){
    applyLang();
    applyTheme();
    $("#langBtn").onclick=()=>{
      state.lang = (state.lang==="ar")?"en":"ar";
      persist("lang");
      applyLang(); renderGame(); refreshHistory();
    };
    $("#themeBtn").onclick=()=>{
      state.theme = (state.theme==="light")?"dark":"light";
      persist("theme");
      applyTheme();
    };
    $("#ttsTest").onclick=()=> testTTS();
    $("#resetBtn").onclick=()=> resetAll();
    $("#levelSel").onchange=(e)=>{ state.settings.level=e.target.value; persist("settings"); refreshFiltered(); buildOrder(); goCurrent(0); };
    $("#topicSel").onchange=(e)=>{ state.settings.topic=e.target.value; persist("settings"); refreshFiltered(); buildOrder(); goCurrent(0); };
    $("#challengeLevel").value = state.challenge.level||"All";
    $("#challengeCount").value = state.challenge.total||10;
    $("#startChallenge").onclick=()=> startChallenge();
    $("#loadJsonBtn").onclick=()=> $("#jsonLoader").click();
    $("#jsonLoader").onchange=(e)=>{ const f=e.target.files?.[0]; if(f) loadFromFile(f); e.target.value=""; };
    $("#voiceSel").onchange=(e)=>{
      const idx = Number(e.target.value);
      const v = state.voices[idx];
      if(v){ state.voice = v; }
    };
    $("#rateRange").oninput=(e)=>{ state.audio.rate = Number(e.target.value); persist("audio"); };
    $("#repeatRange").oninput=(e)=>{ state.audio.repeat = Number(e.target.value); persist("audio"); };
    refreshHistory();
  }

  window.addEventListener("DOMContentLoaded", ()=>{
    initUI();
    initVoice();
    loadData();
  });
</script>
</body>
</html>